<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>ç–²å‹é§•é§›åµæ¸¬ç³»çµ± - æ•¸æ“šè¨˜éŒ„ç‰ˆ</title>
  
  <!-- ä½¿ç”¨ç©©å®šç‰ˆæœ¬çš„åº« -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
  <script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <!-- åŠ å…¥ SheetJS ç”¨æ–¼ Excel å°å‡º -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Arial', 'Microsoft JhengHei', sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    h1 {
      font-size: 2.5em;
      margin-bottom: 30px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .status-panel {
      display: flex;
      justify-content: space-around;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .status-card {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      padding: 20px;
      min-width: 250px;
      flex: 1;
      backdrop-filter: blur(5px);
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    
    .status-card.alert-warning {
      background: rgba(255, 87, 34, 0.3);
      border-color: #ff5722;
      animation: pulse 1s infinite;
    }
    
    .status-card.alert-normal {
      background: rgba(76, 175, 80, 0.3);
      border-color: #4caf50;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }
    
    #label {
      font-size: 1.8em;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    #confidence {
      font-size: 1.2em;
      opacity: 0.9;
    }
    
    .model-input-section {
      margin: 20px 0;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
    }

    .model-input {
      width: 80%;
      max-width: 500px;
      padding: 12px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 16px;
      margin: 10px;
    }

    .model-input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }
    
    .video-section {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 30px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    
    #videoCanvas {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      background: rgba(0, 0, 0, 0.5);
    }
    
    .chart-container {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      min-width: 400px;
    }
    
    .controls {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    button {
      background: linear-gradient(45deg, #ff6b6b, #feca57);
      border: none;
      padding: 12px 25px;
      font-size: 16px;
      color: white;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      min-width: 120px;
    }
    
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .download-btn {
      background: linear-gradient(45deg, #4caf50, #45a049);
    }
    
    .stats {
      display: flex;
      justify-content: space-around;
      margin-top: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .stat-item {
      text-align: center;
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 15px;
      min-width: 150px;
      flex: 1;
    }
    
    .stat-number {
      font-size: 2.5em;
      font-weight: bold;
      color: #feca57;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 0.9em;
      opacity: 0.8;
    }
    
    .data-section {
      margin-top: 30px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
    }
    
    .data-table-container {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      padding: 15px;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      color: #333;
      font-size: 14px;
    }
    
    .data-table th,
    .data-table td {
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    .data-table th {
      background-color: #f2f2f2;
      font-weight: bold;
      position: sticky;
      top: 0;
    }
    
    .data-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    .data-table tr:hover {
      background-color: #f5f5f5;
    }
    
    .warning-row {
      background-color: #ffebee !important;
    }
    
    .normal-row {
      background-color: #e8f5e8 !important;
    }
    
    .message-container {
      margin: 20px 0;
    }
    
    .error-message {
      background: rgba(255, 0, 0, 0.2);
      border: 2px solid #ff0000;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      color: #ffcccc;
    }
    
    .success-message {
      background: rgba(76, 175, 80, 0.2);
      border: 2px solid #4caf50;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      color: #ccffcc;
    }
    
    .info-message {
      background: rgba(33, 150, 243, 0.2);
      border: 2px solid #2196f3;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      color: #cce7ff;
    }
    
    .debug-info {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 12px;
      text-align: left;
      color: #ccc;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .system-status {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 20px 0;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ff0000;
    }
    
    .status-indicator.ready {
      background: #4caf50;
    }
    
    .status-indicator.loading {
      background: #ffc107;
      animation: blink 1s infinite;
    }
    
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.3; }
    }
    
    .session-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .session-info span {
      font-size: 14px;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš— æ™ºèƒ½ç–²å‹é§•é§›åµæ¸¬ç³»çµ±</h1>
    
    <div class="system-status">
      <div class="status-indicator" id="systemIndicator"></div>
      <span id="systemStatus">ç³»çµ±æº–å‚™ä¸­...</span>
    </div>
    
    <div class="session-info">
      <span>ğŸ“… é–‹å§‹æ™‚é–“ï¼š<span id="sessionStartTime">--</span></span>
      <span>â±ï¸ é‹è¡Œæ™‚é–“ï¼š<span id="sessionDuration">00:00:00</span></span>
      <span>ğŸ“Š è¨˜éŒ„æ•¸é‡ï¼š<span id="recordCount">0</span></span>
    </div>
    
    <div class="model-input-section">
      <h3>ğŸ“‹ æ¨¡å‹è¨­å®š</h3>
      <input type="text" id="modelUrlInput" class="model-input" 
             placeholder="è«‹è¼¸å…¥ Teachable Machine æ¨¡å‹ URL"
             value="https://teachablemachine.withgoogle.com/models/Si9BFwEvA/">
      <br>
      <button onclick="updateModelUrl()">ğŸ”„ æ›´æ–°æ¨¡å‹</button>
      <button onclick="useBuiltinModel()">ğŸ  ä½¿ç”¨å…§å»ºæ¨¡å‹</button>
    </div>
    
    <div class="status-panel">
      <div class="status-card" id="statusCard1">
        <div id="label">ç‹€æ…‹ï¼šç³»çµ±æº–å‚™ä¸­...</div>
        <div id="confidence">ä¿¡å¿ƒå€¼ï¼š0%</div>
      </div>
      <div class="status-card" id="statusCard2">
        <div id="detectionResults">å‰3åé æ¸¬ï¼š<br>ç­‰å¾…åˆå§‹åŒ–...</div>
      </div>
    </div>
    
    <div class="message-container" id="messageContainer"></div>
    
    <div class="video-section">
      <div id="videoCanvas"></div>
      <div class="chart-container">
        <canvas id="confidenceChart" width="400" height="250"></canvas>
      </div>
    </div>
    
    <div class="controls">
      <button id="initBtn" onclick="initializeSystem()">ğŸš€ åˆå§‹åŒ–ç³»çµ±</button>
      <button id="retryBtn" onclick="retryInitialization()" style="display:none;">ğŸ”„ é‡æ–°åˆå§‹åŒ–</button>
      <button id="testBtn" onclick="enableTestMode()">ğŸ§ª æ¸¬è©¦æ¨¡å¼</button>
      <button id="toggleBtn" onclick="toggleClassification()" disabled>â¸ï¸ æš«åœåµæ¸¬</button>
      <button id="resetBtn" onclick="resetStats()">ğŸ”„ é‡ç½®çµ±è¨ˆ</button>
    </div>
    
    <div class="stats">
      <div class="stat-item">
        <div class="stat-number" id="normalCount">0</div>
        <div class="stat-label">æ­£å¸¸é§•é§›æ¬¡æ•¸</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="warningCount">0</div>
        <div class="stat-label">è­¦å‘Šæ¬¡æ•¸</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="totalDetections">0</div>
        <div class="stat-label">ç¸½åµæ¸¬æ¬¡æ•¸</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="accuracyRate">0%</div>
        <div class="stat-label">æª¢æ¸¬æº–ç¢ºç‡</div>
      </div>
    </div>
    
    <!-- æ•¸æ“šè¨˜éŒ„å€åŸŸ -->
    <div class="data-section">
      <h3>ğŸ“Š æ•¸æ“šè¨˜éŒ„èˆ‡åˆ†æ</h3>
      <div class="controls">
        <button class="download-btn" onclick="downloadExcel()">ğŸ“¥ ä¸‹è¼‰ Excel</button>
        <button class="download-btn" onclick="downloadCSV()">ğŸ“„ ä¸‹è¼‰ CSV</button>
        <button onclick="clearDataRecords()">ğŸ—‘ï¸ æ¸…é™¤è¨˜éŒ„</button>
        <button onclick="exportSummaryReport()">ğŸ“‹ åŒ¯å‡ºå ±å‘Š</button>
      </div>
      
      <div class="data-table-container">
        <table class="data-table" id="dataTable">
          <thead>
            <tr>
              <th>æ™‚é–“</th>
              <th>ç‹€æ…‹</th>
              <th>ä¿¡å¿ƒåº¦</th>
              <th>ç¬¬äºŒé æ¸¬</th>
              <th>ç¬¬ä¸‰é æ¸¬</th>
              <th>é¢¨éšªç­‰ç´š</th>
              <th>å‚™è¨»</th>
            </tr>
          </thead>
          <tbody id="dataTableBody">
            <!-- æ•¸æ“šå°‡å‹•æ…‹æ’å…¥é€™è£¡ -->
          </tbody>
        </table>
      </div>
    </div>

    <div class="debug-info" id="debugInfo">
      <div><strong>ğŸ” ç³»çµ±èª¿è©¦ä¿¡æ¯ï¼š</strong></div>
      <div id="debugLog">ç³»çµ±å•Ÿå‹•ä¸­...</div>
    </div>
  </div>

  <script>
    // ==================== å…¨åŸŸè®Šæ•¸ ====================
    let video = null;
    let classifier = null;
    let label = "ç³»çµ±æº–å‚™ä¸­...";
    let confidence = 0;
    let modelURL = "https://teachablemachine.withgoogle.com/models/Si9BFwEvA/";
    
    // ç³»çµ±ç‹€æ…‹
    let systemReady = false;
    let testMode = false;
    let classificationPaused = false;
    let initializationInProgress = false;
    let videoReady = false;
    let modelLoaded = false;
    
    // éŸ³é »ç›¸é—œ
    let isSpeaking = false;
    let audioCtx = null;
    
    // åœ–è¡¨èˆ‡æ•¸æ“š
    let chart = null;
    let maxDataPoints = 50;
    
    // çµ±è¨ˆæ•¸æ“š
    let normalCount = 0;
    let warningCount = 0;
    let totalDetections = 0;
    let correctDetections = 0;
    
    // æ•¸æ“šè¨˜éŒ„
    let dataRecords = [];
    let sessionStartTime = null;
    let sessionTimer = null;
    
    // å…§å»ºç°¡å–®æ¨¡å‹ï¼ˆç”¨æ–¼æ¸¬è©¦ï¼‰
    const builtinModel = {
      labels: ['Normal', 'Tired', 'Drowsy'],
      predict: function() {
        const random = Math.random();
        if (random < 0.7) {
          return [
            { label: 'Normal', confidence: 0.8 + Math.random() * 0.2 },
            { label: 'Tired', confidence: 0.1 + Math.random() * 0.1 },
            { label: 'Drowsy', confidence: 0.05 + Math.random() * 0.05 }
          ];
        } else if (random < 0.9) {
          return [
            { label: 'Tired', confidence: 0.7 + Math.random() * 0.2 },
            { label: 'Normal', confidence: 0.2 + Math.random() * 0.1 },
            { label: 'Drowsy', confidence: 0.05 + Math.random() * 0.05 }
          ];
        } else {
          return [
            { label: 'Drowsy', confidence: 0.8 + Math.random() * 0.2 },
            { label: 'Tired', confidence: 0.1 + Math.random() * 0.1 },
            { label: 'Normal', confidence: 0.05 + Math.random() * 0.05 }
          ];
        }
      }
    };

    // ==================== æ•¸æ“šè¨˜éŒ„åŠŸèƒ½ ====================
    
    // é–‹å§‹æœƒè©±
    function startSession() {
      sessionStartTime = new Date();
      document.getElementById('sessionStartTime').textContent = sessionStartTime.toLocaleString();
      
      // é–‹å§‹è¨ˆæ™‚å™¨
      sessionTimer = setInterval(updateSessionDuration, 1000);
      
      debugLog('æœƒè©±é–‹å§‹: ' + sessionStartTime.toLocaleString());
    }
    
    // æ›´æ–°æœƒè©±æŒçºŒæ™‚é–“
    function updateSessionDuration() {
      if (!sessionStartTime) return;
      
      const now = new Date();
      const duration = now - sessionStartTime;
      const hours = Math.floor(duration / 3600000);
      const minutes = Math.floor((duration % 3600000) / 60000);
      const seconds = Math.floor((duration % 60000) / 1000);
      
      const durationStr = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      document.getElementById('sessionDuration').textContent = durationStr;
    }
    
    // æ·»åŠ æ•¸æ“šè¨˜éŒ„
    function addDataRecord(results) {
      const now = new Date();
      const topResult = results[0];
      const secondResult = results[1] || { label: 'N/A', confidence: 0 };
      const thirdResult = results[2] || { label: 'N/A', confidence: 0 };
      
      // åˆ¤æ–·é¢¨éšªç­‰ç´š
      let riskLevel = 'ä½';
      let remarks = '';
      
      const fatigueKeywords = ['tired', 'drowsy', 'sleepy', 'ç–²å‹', 'æ‰“çŒç¡'];
      const isFatigue = fatigueKeywords.some(keyword => 
        topResult.label.toLowerCase().includes(keyword)
      );
      
      if (isFatigue && topResult.confidence > 0.8) {
        riskLevel = 'é«˜';
        remarks = 'é«˜åº¦ç–²å‹è­¦å‘Š';
      } else if (isFatigue && topResult.confidence > 0.6) {
        riskLevel = 'ä¸­';
        remarks = 'ç–²å‹å¾µè±¡';
      } else if (topResult.confidence < 0.5) {
        riskLevel = 'æœªçŸ¥';
        remarks = 'æª¢æ¸¬ä¸ç¢ºå®š';
      }
      
      const record = {
        timestamp: now,
        timeString: now.toLocaleString(),
        status: topResult.label,
        confidence: topResult.confidence,
        secondPrediction: `${secondResult.label} (${(secondResult.confidence * 100).toFixed(1)}%)`,
        thirdPrediction: `${thirdResult.label} (${(thirdResult.confidence * 100).toFixed(1)}%)`,
        riskLevel: riskLevel,
        remarks: remarks,
        isFatigue: isFatigue
      };
      
      dataRecords.push(record);
      
      // é™åˆ¶è¨˜éŒ„æ•¸é‡ï¼ˆä¿ç•™æœ€è¿‘1000æ¢ï¼‰
      if (dataRecords.length > 1000) {
        dataRecords = dataRecords.slice(-1000);
      }
      
      // æ›´æ–°è¡¨æ ¼é¡¯ç¤º
      updateDataTable();
      
      // æ›´æ–°è¨˜éŒ„è¨ˆæ•¸
      document.getElementById('recordCount').textContent = dataRecords.length;
    }
    
    // æ›´æ–°æ•¸æ“šè¡¨æ ¼
    function updateDataTable() {
      const tableBody = document.getElementById('dataTableBody');
      if (!tableBody) return;
      
      // åªé¡¯ç¤ºæœ€è¿‘50æ¢è¨˜éŒ„
      const recentRecords = dataRecords.slice(-50).reverse();
      
      tableBody.innerHTML = recentRecords.map(record => {
        const rowClass = record.isFatigue ? 'warning-row' : 'normal-row';
        return `
          <tr class="${rowClass}">
            <td>${record.timeString}</td>
            <td>${record.status}</td>
            <td>${(record.confidence * 100).toFixed(1)}%</td>
            <td>${record.secondPrediction}</td>
            <td>${record.thirdPrediction}</td>
            <td>${record.riskLevel}</td>
            <td>${record.remarks}</td>
          </tr>
        `;
      }).join('');
    }
    
    // ä¸‹è¼‰ Excel æ–‡ä»¶
    function downloadExcel() {
      if (dataRecords.length === 0) {
        showMessage('âŒ æ²’æœ‰æ•¸æ“šå¯ä»¥ä¸‹è¼‰', 'error', true);
        return;
      }
      
      try {
        // æº–å‚™æ•¸æ“š
        const excelData = dataRecords.map(record => ({
          'æ™‚é–“': record.timeString,
          'ç‹€æ…‹': record.status,
          'ä¿¡å¿ƒåº¦': `${(record.confidence * 100).toFixed(2)}%`,
          'ç¬¬äºŒé æ¸¬': record.secondPrediction,
          'ç¬¬ä¸‰é æ¸¬': record.thirdPrediction,
          'é¢¨éšªç­‰ç´š': record.riskLevel,
          'å‚™è¨»': record.remarks
        }));
        
        // å‰µå»ºå·¥ä½œç°¿
        const wb = XLSX.utils.book_new();
        
        // ä¸»æ•¸æ“šå·¥ä½œè¡¨
        const ws = XLSX.utils.json_to_sheet(excelData);
        XLSX.utils.book_append_sheet(wb, ws, 'æª¢æ¸¬è¨˜éŒ„');
        
        // çµ±è¨ˆæ‘˜è¦å·¥ä½œè¡¨
        const summaryData = generateSummaryData();
        const summaryWs = XLSX.utils.json_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(wb, summaryWs, 'çµ±è¨ˆæ‘˜è¦');
        
        // ç”Ÿæˆæ–‡ä»¶å
        const fileName = `ç–²å‹é§•é§›æª¢æ¸¬è¨˜éŒ„_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.xlsx`;
        
        // ä¸‹è¼‰æ–‡ä»¶
        XLSX.writeFile(wb, fileName);
        
        showMessage('âœ… Excel æ–‡ä»¶ä¸‹è¼‰æˆåŠŸ', 'success', true);
        debugLog('Excel æ–‡ä»¶å·²ä¸‹è¼‰: ' + fileName);
        
      } catch (error) {
        debugLog('Excel ä¸‹è¼‰å¤±æ•—: ' + error.message);
        showMessage('âŒ Excel ä¸‹è¼‰å¤±æ•—: ' + error.message, 'error', true);
      }
    }
    
    // ä¸‹è¼‰ CSV æ–‡ä»¶
    function downloadCSV() {
      if (dataRecords.length === 0) {
        showMessage('âŒ æ²’æœ‰æ•¸æ“šå¯ä»¥ä¸‹è¼‰', 'error', true);
        return;
      }
      
      try {
        // æº–å‚™ CSV æ•¸æ“š
        const csvHeader = 'æ™‚é–“,ç‹€æ…‹,ä¿¡å¿ƒåº¦,ç¬¬äºŒé æ¸¬,ç¬¬ä¸‰é æ¸¬,é¢¨éšªç­‰ç´š,å‚™è¨»\n';
        const csvData = dataRecords.map(record => 
          `"${record.timeString}","${record.status}","${(record.confidence * 100).toFixed(2)}%","${record.secondPrediction}","${record.thirdPrediction}","${record.riskLevel}","${record.remarks}"`
        ).join('\n');
        
        const csvContent = csvHeader + csvData;
        
        // å‰µå»ºä¸‹è¼‰éˆæ¥
        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const fileName = `ç–²å‹é§•é§›æª¢æ¸¬è¨˜éŒ„_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
        
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();
        
        showMessage('âœ… CSV æ–‡ä»¶ä¸‹è¼‰æˆåŠŸ', 'success', true);
        debugLog('CSV æ–‡ä»¶å·²ä¸‹è¼‰: ' + fileName);
        
      } catch (error) {
        debugLog('CSV ä¸‹è¼‰å¤±æ•—: ' + error.message);
        showMessage('âŒ CSV ä¸‹è¼‰å¤±æ•—: ' + error.message, 'error', true);
      }
    }
    
    // ç”Ÿæˆçµ±è¨ˆæ‘˜è¦æ•¸æ“š
    function generateSummaryData() {
      const now = new Date();
      const sessionDuration = sessionStartTime ? (now - sessionStartTime) / 1000 / 60 : 0; // åˆ†é˜
      
      const fatigueRecords = dataRecords.filter(r => r.isFatigue);
      const highRiskRecords = dataRecords.filter(r => r.riskLevel === 'é«˜');
      const mediumRiskRecords = dataRecords.filter(r => r.riskLevel === 'ä¸­');
      
      const avgConfidence = dataRecords.length > 0 ? 
        dataRecords.reduce((sum, r) => sum + r.confidence, 0) / dataRecords.length : 0;
      
      return [
        { 'çµ±è¨ˆé …ç›®': 'æœƒè©±é–‹å§‹æ™‚é–“', 'æ•¸å€¼': sessionStartTime ? sessionStartTime.toLocaleString() : 'N/A' },
        { 'çµ±è¨ˆé …ç›®': 'æœƒè©±æŒçºŒæ™‚é–“ï¼ˆåˆ†é˜ï¼‰', 'æ•¸å€¼': sessionDuration.toFixed(1) },
        { 'çµ±è¨ˆé …ç›®': 'ç¸½æª¢æ¸¬æ¬¡æ•¸', 'æ•¸å€¼': dataRecords.length },
        { 'çµ±è¨ˆé …ç›®': 'æ­£å¸¸ç‹€æ…‹æ¬¡æ•¸', 'æ•¸å€¼': normalCount },
        { 'çµ±è¨ˆé …ç›®': 'ç–²å‹è­¦å‘Šæ¬¡æ•¸', 'æ•¸å€¼': warningCount },
        { 'çµ±è¨ˆé …ç›®': 'é«˜é¢¨éšªæ¬¡æ•¸', 'æ•¸å€¼': highRiskRecords.length },
        { 'çµ±è¨ˆé …ç›®': 'ä¸­é¢¨éšªæ¬¡æ•¸', 'æ•¸å€¼': mediumRiskRecords.length },
        { 'çµ±è¨ˆé …ç›®': 'ç–²å‹æª¢å‡ºç‡', 'æ•¸å€¼': `${((fatigueRecords.length / Math.max(dataRecords.length, 1)) * 100).toFixed(2)}%` },
        { 'çµ±è¨ˆé …ç›®': 'å¹³å‡æª¢æ¸¬ä¿¡å¿ƒåº¦', 'æ•¸å€¼': `${(avgConfidence * 100).toFixed(2)}%` },
        { 'çµ±è¨ˆé …ç›®': 'å ±å‘Šç”Ÿæˆæ™‚é–“', 'æ•¸å€¼': now.toLocaleString() }
      ];
    }
    
    // åŒ¯å‡ºæ‘˜è¦å ±å‘Š
    function exportSummaryReport() {
      if (dataRecords.length === 0) {
        showMessage('âŒ æ²’æœ‰æ•¸æ“šå¯ä»¥åŒ¯å‡º', 'error', true);
        return;
      }
      
      try {
        const summaryData = generateSummaryData();
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(wb, ws, 'æ‘˜è¦å ±å‘Š');
        
        const fileName = `ç–²å‹é§•é§›æª¢æ¸¬æ‘˜è¦å ±å‘Š_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        showMessage('âœ… æ‘˜è¦å ±å‘ŠåŒ¯å‡ºæˆåŠŸ', 'success', true);
        debugLog('æ‘˜è¦å ±å‘Šå·²åŒ¯å‡º: ' + fileName);
        
      } catch (error) {
        debugLog('æ‘˜è¦å ±å‘ŠåŒ¯å‡ºå¤±æ•—: ' + error.message);
        showMessage('âŒ æ‘˜è¦å ±å‘ŠåŒ¯å‡ºå¤±æ•—: ' + error.message, 'error', true);
      }
    }
    
    // æ¸…é™¤æ•¸æ“šè¨˜éŒ„
    function clearDataRecords() {
      if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ•¸æ“šè¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
        dataRecords = [];
        updateDataTable();
        document.getElementById('recordCount').textContent = '0';
        showMessage('âœ… æ•¸æ“šè¨˜éŒ„å·²æ¸…é™¤', 'success', true);
        debugLog('æ•¸æ“šè¨˜éŒ„å·²æ¸…é™¤');
      }
    }

    // ==================== å·¥å…·å‡½æ•¸ ====================
    
    // å®‰å…¨çš„èª¿è©¦æ—¥èªŒ
    function debugLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      const logMessage = `${timestamp}: ${message}`;
      
      console.log(logMessage);
      
      try {
        const debugElement = document.getElementById('debugLog');
        if (debugElement) {
          debugElement.innerHTML += `<br>${logMessage}`;
          debugElement.scrollTop = debugElement.scrollHeight;
          
          // é™åˆ¶æ—¥èªŒæ¢æ•¸
          const lines = debugElement.innerHTML.split('<br>');
          if (lines.length > 100) {
            debugElement.innerHTML = lines.slice(-80).join('<br>');
          }
        }
      } catch (error) {
        console.error('èª¿è©¦æ—¥èªŒé¡¯ç¤ºéŒ¯èª¤:', error);
      }
    }
    
    // æ›´æ–°ç³»çµ±ç‹€æ…‹æŒ‡ç¤ºå™¨
    function updateSystemStatus(status, message) {
      const indicator = document.getElementById('systemIndicator');
      const statusText = document.getElementById('systemStatus');
      
      if (indicator && statusText) {
        indicator.className = `status-indicator ${status}`;
        statusText.textContent = message;
      }
    }
    
    // é¡¯ç¤ºè¨Šæ¯
    function showMessage(message, type = 'info', autoHide = false) {
      const messageContainer = document.getElementById('messageContainer');
      if (!messageContainer) return;
      
      const className = `${type}-message`;
      messageContainer.innerHTML = `
        <div class="${className}">
          ${message}
        </div>
      `;
      
      if (autoHide) {
        setTimeout(() => {
          messageContainer.innerHTML = '';
        }, 5000);
      }
    }
    
    // å®‰å…¨çš„å…ƒç´ æ›´æ–°
    function safeUpdateElement(id, content) {
      try {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = content;
        }
      } catch (error) {
        debugLog(`æ›´æ–°å…ƒç´  ${id} å¤±æ•—: ${error.message}`);
      }
    }
    
    // æª¢æŸ¥ä¾è³´é …
    function checkDependencies() {
      const deps = {
        p5: typeof p5 !== 'undefined',
        ml5: typeof ml5 !== 'undefined',
        Chart: typeof Chart !== 'undefined',
        XLSX: typeof XLSX !== 'undefined'
      };
      
      debugLog(`ä¾è³´æª¢æŸ¥ - p5: ${deps.p5}, ml5: ${deps.ml5}, Chart: ${deps.Chart}, XLSX: ${deps.XLSX}`);
      return deps;
    }
    
    // ==================== åœ–è¡¨åŠŸèƒ½ ====================
    
    function initializeChart() {
      try {
        const ctx = document.getElementById('confidenceChart');
        if (!ctx) {
          debugLog('æ‰¾ä¸åˆ°åœ–è¡¨ç•«å¸ƒå…ƒç´ ');
          return;
        }
        
        chart = new Chart(ctx.getContext('2d'), {
          type: 'line',
          data: {
            labels: [],
            datasets: [{
              label: 'æª¢æ¸¬ä¿¡å¿ƒåº¦',
              data: [],
              borderColor: 'rgb(75, 192, 192)',
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              tension: 0.4,
              fill: true,
              pointRadius: 3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                max: 1,
                ticks: {
                  callback: function(value) {
                    return (value * 100).toFixed(0) + '%';
                  }
                }
              },
              x: {
                display: false
              }
            },
            plugins: {
              title: {
                display: true,
                text: 'ç–²å‹æª¢æ¸¬ä¿¡å¿ƒåº¦è®ŠåŒ–',
                color: '#333',
                font: { size: 16 }
              },
              legend: {
                labels: { color: '#333' }
              }
            },
            animation: {
              duration: 300
            }
          }
        });
        
        debugLog('åœ–è¡¨åˆå§‹åŒ–æˆåŠŸ');
      } catch (error) {
        debugLog('åœ–è¡¨åˆå§‹åŒ–å¤±æ•—: ' + error.message);
      }
    }
    
    function updateChart(confidence) {
      if (!chart) return;
      
      try {
        const now = new Date().toLocaleTimeString();
        
        // æ·»åŠ æ–°æ•¸æ“šé»
        chart.data.labels.push(now);
        chart.data.datasets[0].data.push(confidence);
        
        // é™åˆ¶æ•¸æ“šé»æ•¸é‡
        if (chart.data.labels.length > maxDataPoints) {
          chart.data.labels.shift();
          chart.data.datasets[0].data.shift();
        }
        
        chart.update('none');
      } catch (error) {
        debugLog('åœ–è¡¨æ›´æ–°å¤±æ•—: ' + error.message);
      }
    }
    
    // ==================== éŸ³é »è­¦å‘ŠåŠŸèƒ½ ====================
    
    function initializeAudio() {
      try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        debugLog('éŸ³é »ä¸Šä¸‹æ–‡åˆå§‹åŒ–æˆåŠŸ');
      } catch (error) {
        debugLog('éŸ³é »åˆå§‹åŒ–å¤±æ•—: ' + error.message);
      }
    }
    
    function playWarningSound() {
      if (!audioCtx || isSpeaking) return;
      
      try {
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
        oscillator.frequency.setValueAtTime(600, audioCtx.currentTime + 0.1);
        oscillator.frequency.setValueAtTime(800, audioCtx.currentTime + 0.2);
        
        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
        
        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.3);
        
        debugLog('æ’­æ”¾è­¦å‘ŠéŸ³æ•ˆ');
      } catch (error) {
        debugLog('æ’­æ”¾éŸ³æ•ˆå¤±æ•—: ' + error.message);
      }
    }
    
    function speakWarning(text) {
      if (!('speechSynthesis' in window) || isSpeaking) return;
      
      try {
        isSpeaking = true;
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-TW';
        utterance.rate = 1.2;
        utterance.pitch = 1.1;
        utterance.volume = 0.8;
        
        utterance.onend = () => {
          isSpeaking = false;
        };
        
        utterance.onerror = () => {
          isSpeaking = false;
        };
        
        speechSynthesis.speak(utterance);
        debugLog('èªéŸ³è­¦å‘Š: ' + text);
      } catch (error) {
        isSpeaking = false;
        debugLog('èªéŸ³è­¦å‘Šå¤±æ•—: ' + error.message);
      }
    }
    
    // ==================== ç³»çµ±åˆå§‹åŒ– ====================
    
    function initializeSystem() {
      if (initializationInProgress) {
        debugLog('åˆå§‹åŒ–å·²åœ¨é€²è¡Œä¸­ï¼Œè«‹ç¨å€™...');
        return;
      }
      
      initializationInProgress = true;
      updateSystemStatus('loading', 'ç³»çµ±åˆå§‹åŒ–ä¸­...');
      
      debugLog('é–‹å§‹ç³»çµ±åˆå§‹åŒ–');
      
      // æª¢æŸ¥ä¾è³´é …
      const deps = checkDependencies();
      if (!deps.p5 || !deps.ml5 || !deps.Chart || !deps.XLSX) {
        const missing = Object.entries(deps)
          .filter(([key, value]) => !value)
          .map(([key]) => key);
        
        showMessage(`âŒ ç¼ºå°‘å¿…è¦ä¾è³´é …: ${missing.join(', ')}`, 'error');
        initializationInProgress = false;
        updateSystemStatus('error', 'ä¾è³´é …è¼‰å…¥å¤±æ•—');
        return;
      }
      
      try {
        // åˆå§‹åŒ–å„å€‹çµ„ä»¶
        initializeChart();
        initializeAudio();
        
        // é–‹å§‹æœƒè©±
        if (!sessionStartTime) {
          startSession();
        }
        
        // åˆå§‹åŒ– p5.js
        new p5(sketch);
        
        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        document.getElementById('initBtn').style.display = 'none';
        document.getElementById('retryBtn').style.display = 'inline-block';
        
        showMessage('âœ… ç³»çµ±åˆå§‹åŒ–æˆåŠŸï¼Œæ­£åœ¨è¼‰å…¥æ”åƒé ­...', 'success', true);
        debugLog('ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
        
      } catch (error) {
        debugLog('ç³»çµ±åˆå§‹åŒ–å¤±æ•—: ' + error.message);
        showMessage('âŒ ç³»çµ±åˆå§‹åŒ–å¤±æ•—: ' + error.message, 'error');
        initializationInProgress = false;
        updateSystemStatus('error', 'åˆå§‹åŒ–å¤±æ•—');
      }
    }
    
    function retryInitialization() {
      debugLog('é‡æ–°åˆå§‹åŒ–ç³»çµ±');
      
      // é‡ç½®ç‹€æ…‹
      systemReady = false;
      videoReady = false;
      modelLoaded = false;
      initializationInProgress = false;
      
      // é‡ç½®UI
      document.getElementById('initBtn').style.display = 'inline-block';
      document.getElementById('retryBtn').style.display = 'none';
      document.getElementById('toggleBtn').disabled = true;
      
      // æ¸…ç†ç¾æœ‰è³‡æº
      if (video && video.remove) {
        video.remove();
        video = null;
      }
      
      if (classifier) {
        classifier = null;
      }
      
      // é‡æ–°åˆå§‹åŒ–
      setTimeout(() => {
        initializeSystem();
      }, 1000);
    }
    
    // ==================== p5.js ä¸»ç¨‹åº ====================
    
    function sketch(p) {
      p.setup = function() {
        debugLog('p5.js setup é–‹å§‹');
        
        try {
          // å‰µå»ºç•«å¸ƒ
          const canvas = p.createCanvas(640, 480);
          canvas.parent('videoCanvas');
          
          // åˆå§‹åŒ–æ”åƒé ­
          video = p.createCapture(p.VIDEO, videoReady);
          video.size(640, 480);
          video.hide();
          
          debugLog('p5.js ç•«å¸ƒå’Œæ”åƒé ­å‰µå»ºå®Œæˆ');
          
        } catch (error) {
          debugLog('p5.js setup å¤±æ•—: ' + error.message);
          showMessage('âŒ æ”åƒé ­åˆå§‹åŒ–å¤±æ•—: ' + error.message, 'error');
          initializationInProgress = false;
          updateSystemStatus('error', 'æ”åƒé ­åˆå§‹åŒ–å¤±æ•—');
        }
      };
      
      function videoReady() {
        debugLog('æ”åƒé ­æº–å‚™å°±ç·’');
        videoReady = true;
        
        // è¼‰å…¥æ¨¡å‹
        loadModel();
      }
      
      function loadModel() {
        debugLog('é–‹å§‹è¼‰å…¥æ¨¡å‹: ' + modelURL);
        updateSystemStatus('loading', 'è¼‰å…¥AIæ¨¡å‹ä¸­...');
        
        try {
          if (testMode) {
            // ä½¿ç”¨å…§å»ºæ¸¬è©¦æ¨¡å‹
            classifier = builtinModel;
            modelLoaded = true;
            onModelReady();
          } else {
            // è¼‰å…¥ Teachable Machine æ¨¡å‹
            classifier = ml5.imageClassifier(modelURL + 'model.json', onModelReady);
          }
        } catch (error) {
          debugLog('æ¨¡å‹è¼‰å…¥å¤±æ•—: ' + error.message);
          showMessage('âŒ æ¨¡å‹è¼‰å…¥å¤±æ•—: ' + error.message, 'error');
          initializationInProgress = false;
          updateSystemStatus('error', 'æ¨¡å‹è¼‰å…¥å¤±æ•—');
        }
      }
      
      function onModelReady() {
        debugLog('æ¨¡å‹è¼‰å…¥å®Œæˆ');
        modelLoaded = true;
        systemReady = true;
        initializationInProgress = false;
        
        updateSystemStatus('ready', 'ç³»çµ±å°±ç·’');
        showMessage('âœ… ç³»çµ±æº–å‚™å®Œæˆï¼Œé–‹å§‹ç–²å‹æª¢æ¸¬', 'success', true);
        
        // å•Ÿç”¨æ§åˆ¶æŒ‰éˆ•
        document.getElementById('toggleBtn').disabled = false;
        
        // é–‹å§‹åˆ†é¡
        classifyVideo();
      }
      
      p.draw = function() {
        if (!video || !videoReady) {
          p.background(50);
          p.fill(255);
          p.textAlign(p.CENTER, p.CENTER);
          p.textSize(24);
          p.text('ç­‰å¾…æ”åƒé ­åˆå§‹åŒ–...', p.width/2, p.height/2);
          return;
        }
        
        // ç¹ªè£½è¦–é »
        p.image(video, 0, 0, 640, 480);
        
        // ç¹ªè£½æª¢æ¸¬æ¡†
        p.stroke(255, 255, 0);
        p.strokeWeight(3);
        p.noFill();
        p.rect(160, 120, 320, 240);
        
        // é¡¯ç¤ºæª¢æ¸¬çµæœ
        if (systemReady) {
          p.fill(0, 0, 0, 150);
          p.rect(0, 0, 640, 80);
          
          p.fill(255);
          p.textAlign(p.LEFT, p.TOP);
          p.textSize(18);
          p.text(`ç‹€æ…‹: ${label}`, 20, 20);
          p.text(`ä¿¡å¿ƒåº¦: ${(confidence * 100).toFixed(1)}%`, 20, 45);
          
          // ç‹€æ…‹æŒ‡ç¤ºç‡ˆ
          const statusColor = label.toLowerCase().includes('tired') || 
                             label.toLowerCase().includes('drowsy') || 
                             label.toLowerCase().includes('ç–²å‹') ? 
                             p.color(255, 0, 0) : p.color(0, 255, 0);
          
          p.fill(statusColor);
          p.noStroke();
          p.circle(600, 35, 30);
        }
        
        // é¡¯ç¤ºæç¤ºæ–‡å­—
        if (!classificationPaused && systemReady) {
          p.fill(255, 255, 0);
          p.textAlign(p.CENTER, p.BOTTOM);
          p.textSize(16);
          p.text('è«‹å°‡è‡‰éƒ¨ç½®æ–¼æ¡†å…§', p.width/2, p.height - 20);
        } else if (classificationPaused) {
          p.fill(255, 100, 100);
          p.textAlign(p.CENTER, p.BOTTOM);
          p.textSize(16);
          p.text('æª¢æ¸¬å·²æš«åœ', p.width/2, p.height - 20);
        }
      };
    }
    
    // ==================== åˆ†é¡åŠŸèƒ½ ====================
    
    function classifyVideo() {
      if (!systemReady || !classifier || !video || classificationPaused) {
        return;
      }
      
      try {
        if (testMode) {
          // æ¸¬è©¦æ¨¡å¼ä½¿ç”¨å…§å»ºæ¨¡å‹
          const results = classifier.predict();
          handleClassificationResults(results);
        } else {
          // ä½¿ç”¨ ml5 æ¨¡å‹
          classifier.classify(video, handleClassificationResults);
        }
      } catch (error) {
        debugLog('åˆ†é¡åŸ·è¡Œå¤±æ•—: ' + error.message);
        setTimeout(classifyVideo, 2000); // 2ç§’å¾Œé‡è©¦
      }
    }
    
    function handleClassificationResults(results) {
      if (!results || results.length === 0) {
        debugLog('æœªæ”¶åˆ°åˆ†é¡çµæœ');
        setTimeout(classifyVideo, 1000);
        return;
      }
      
      try {
        // è™•ç†çµæœ
        const topResult = results[0];
        label = topResult.label || topResult.className || 'æœªçŸ¥';
        confidence = topResult.confidence || 0;
        
        // æ›´æ–°UI
        updateUI(results);
        
        // æ·»åŠ æ•¸æ“šè¨˜éŒ„
        addDataRecord(results);
        
        // æ›´æ–°çµ±è¨ˆ
        updateStatistics(label, confidence);
        
        // æª¢æŸ¥æ˜¯å¦éœ€è¦è­¦å‘Š
        checkForWarning(label, confidence);
        
        // æ›´æ–°åœ–è¡¨
        updateChart(confidence);
        
        // ç¹¼çºŒä¸‹ä¸€æ¬¡åˆ†é¡
        if (!classificationPaused) {
          setTimeout(classifyVideo, 500); // æ¯0.5ç§’æª¢æ¸¬ä¸€æ¬¡
        }
        
      } catch (error) {
        debugLog('è™•ç†åˆ†é¡çµæœå¤±æ•—: ' + error.message);
        setTimeout(classifyVideo, 1000);
      }
    }
    
    function updateUI(results) {
      try {
        // æ›´æ–°ä¸»è¦ç‹€æ…‹
        safeUpdateElement('label', `ç‹€æ…‹ï¼š${label}`);
        safeUpdateElement('confidence', `ä¿¡å¿ƒå€¼ï¼š${(confidence * 100).toFixed(1)}%`);
        
        // æ›´æ–°ç‹€æ…‹å¡ç‰‡æ¨£å¼
        const statusCard = document.getElementById('statusCard1');
        if (statusCard) {
          const fatigueKeywords = ['tired', 'drowsy', 'sleepy', 'ç–²å‹', 'æ‰“çŒç¡'];
          const isFatigue = fatigueKeywords.some(keyword => 
            label.toLowerCase().includes(keyword)
          );
          
          statusCard.className = isFatigue ? 'status-card alert-warning' : 'status-card alert-normal';
        }
        
        // æ›´æ–°å‰3åé æ¸¬
        const detectionResults = document.getElementById('detectionResults');
        if (detectionResults && results.length >= 3) {
          const top3 = results.slice(0, 3).map((result, index) => {
            const resultLabel = result.label || result.className || 'æœªçŸ¥';
            const resultConfidence = ((result.confidence || 0) * 100).toFixed(1);
            return `${index + 1}. ${resultLabel} (${resultConfidence}%)`;
          }).join('<br>');
          
          detectionResults.innerHTML = `å‰3åé æ¸¬ï¼š<br>${top3}`;
        }
        
      } catch (error) {
        debugLog('UIæ›´æ–°å¤±æ•—: ' + error.message);
      }
    }
    
    function updateStatistics(currentLabel, currentConfidence) {
      totalDetections++;
      
      const fatigueKeywords = ['tired', 'drowsy', 'sleepy', 'ç–²å‹', 'æ‰“çŒç¡'];
      const isFatigue = fatigueKeywords.some(keyword => 
        currentLabel.toLowerCase().includes(keyword)
      );
      
      if (isFatigue && currentConfidence > 0.6) {
        warningCount++;
      } else {
        normalCount++;
      }
      
      // è¨ˆç®—æº–ç¢ºç‡ï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼‰
      if (currentConfidence > 0.7) {
        correctDetections++;
      }
      
      const accuracyRate = totalDetections > 0 ? 
        (correctDetections / totalDetections * 100).toFixed(1) : 0;
      
      // æ›´æ–°é¡¯ç¤º
      safeUpdateElement('normalCount', normalCount);
      safeUpdateElement('warningCount', warningCount);
      safeUpdateElement('totalDetections', totalDetections);
      safeUpdateElement('accuracyRate', accuracyRate + '%');
    }
    
    function checkForWarning(currentLabel, currentConfidence) {
      const fatigueKeywords = ['tired', 'drowsy', 'sleepy', 'ç–²å‹', 'æ‰“çŒç¡'];
      const isFatigue = fatigueKeywords.some(keyword => 
        currentLabel.toLowerCase().includes(keyword)
      );
      
      if (isFatigue && currentConfidence > 0.7) {
        playWarningSound();
        
        const warningMessages = [
          'æ³¨æ„ï¼æª¢æ¸¬åˆ°ç–²å‹é§•é§›',
          'è«‹æ³¨æ„ä¼‘æ¯',
          'å»ºè­°åœè»Šä¼‘æ¯'
        ];
        
        const randomMessage = warningMessages[Math.floor(Math.random() * warningMessages.length)];
        speakWarning(randomMessage);
        
        debugLog(`ç–²å‹è­¦å‘Š: ${currentLabel} (${(currentConfidence * 100).toFixed(1)}%)`);
      }
    }
    
    // ==================== æ§åˆ¶åŠŸèƒ½ ====================
    
    function toggleClassification() {
      classificationPaused = !classificationPaused;
      const toggleBtn = document.getElementById('toggleBtn');
      
      if (classificationPaused) {
        toggleBtn.textContent = 'â–¶ï¸ æ¢å¾©åµæ¸¬';
        showMessage('â¸ï¸ æª¢æ¸¬å·²æš«åœ', 'info', true);
        debugLog('æª¢æ¸¬æš«åœ');
      } else {
        toggleBtn.textContent = 'â¸ï¸ æš«åœåµæ¸¬';
        showMessage('â–¶ï¸ æª¢æ¸¬å·²æ¢å¾©', 'info', true);
        debugLog('æª¢æ¸¬æ¢å¾©');
        classifyVideo(); // æ¢å¾©åˆ†é¡
      }
    }
    
    function resetStats() {
      if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰çµ±è¨ˆæ•¸æ“šå—ï¼Ÿ')) {
        normalCount = 0;
        warningCount = 0;
        totalDetections = 0;
        correctDetections = 0;
        
        safeUpdateElement('normalCount', '0');
        safeUpdateElement('warningCount', '0');
        safeUpdateElement('totalDetections', '0');
        safeUpdateElement('accuracyRate', '0%');
        
        // é‡ç½®åœ–è¡¨
        if (chart) {
          chart.data.labels = [];
          chart.data.datasets[0].data = [];
          chart.update();
        }
        
        showMessage('âœ… çµ±è¨ˆæ•¸æ“šå·²é‡ç½®', 'success', true);
        debugLog('çµ±è¨ˆæ•¸æ“šå·²é‡ç½®');
      }
    }
    
    function updateModelUrl() {
      const newUrl = document.getElementById('modelUrlInput').value.trim();
      if (!newUrl) {
        showMessage('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„æ¨¡å‹URL', 'error', true);
        return;
      }
      
      modelURL = newUrl.endsWith('/') ? newUrl : newUrl + '/';
      testMode = false;
      
      showMessage('âœ… æ¨¡å‹URLå·²æ›´æ–°ï¼Œè«‹é‡æ–°åˆå§‹åŒ–ç³»çµ±', 'success', true);
      debugLog('æ¨¡å‹URLæ›´æ–°ç‚º: ' + modelURL);
    }
    
    function useBuiltinModel() {
      testMode = true;
      showMessage('âœ… å·²åˆ‡æ›åˆ°å…§å»ºæ¸¬è©¦æ¨¡å‹', 'success', true);
      debugLog('åˆ‡æ›åˆ°å…§å»ºæ¸¬è©¦æ¨¡å‹');
    }
    
    function enableTestMode() {
      testMode = !testMode;
      const testBtn = document.getElementById('testBtn');
      
      if (testMode) {
        testBtn.textContent = 'ğŸ  æ­£å¸¸æ¨¡å¼';
        showMessage('ğŸ§ª æ¸¬è©¦æ¨¡å¼å·²å•Ÿç”¨', 'info', true);
        debugLog('æ¸¬è©¦æ¨¡å¼å•Ÿç”¨');
      } else {
        testBtn.textContent = 'ğŸ§ª æ¸¬è©¦æ¨¡å¼';
        showMessage('ğŸ  æ­£å¸¸æ¨¡å¼å·²å•Ÿç”¨', 'info', true);
        debugLog('æ­£å¸¸æ¨¡å¼å•Ÿç”¨');
      }
    }
    
    // ==================== é é¢è¼‰å…¥äº‹ä»¶ ====================
    
    window.addEventListener('load', function() {
      debugLog('é é¢è¼‰å…¥å®Œæˆ');
      
      // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showMessage('âŒ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´æ”åƒé ­åŠŸèƒ½', 'error');
        updateSystemStatus('error', 'ç€è¦½å™¨ä¸æ”¯æ´');
        return;
      }
      
      // æª¢æŸ¥ä¾è³´é …
      const deps = checkDependencies();
      if (!deps.p5 || !deps.ml5 || !deps.Chart || !deps.XLSX) {
        showMessage('âŒ æ­£åœ¨è¼‰å…¥å¿…è¦çš„ç¨‹å¼åº«ï¼Œè«‹ç¨å€™...', 'info');
        updateSystemStatus('loading', 'è¼‰å…¥ç¨‹å¼åº«ä¸­...');
        
        // ç­‰å¾…ä¾è³´é …è¼‰å…¥
        let checkCount = 0;
        const checkInterval = setInterval(() => {
          const newDeps = checkDependencies();
          checkCount++;
          
          if (newDeps.p5 && newDeps.ml5 && newDeps.Chart && newDeps.XLSX) {
            clearInterval(checkInterval);
            showMessage('âœ… ç¨‹å¼åº«è¼‰å…¥å®Œæˆï¼Œå¯ä»¥é–‹å§‹åˆå§‹åŒ–ç³»çµ±', 'success', true);
            updateSystemStatus('ready', 'æº–å‚™å°±ç·’');
          } else if (checkCount > 30) { // 30ç§’è¶…æ™‚
            clearInterval(checkInterval);
            showMessage('âŒ ç¨‹å¼åº«è¼‰å…¥è¶…æ™‚ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
            updateSystemStatus('error', 'è¼‰å…¥è¶…æ™‚');
          }
        }, 1000);
      } else {
        showMessage('âœ… ç³»çµ±æº–å‚™å®Œæˆï¼Œé»æ“Šåˆå§‹åŒ–æŒ‰éˆ•é–‹å§‹', 'success', true);
        updateSystemStatus('ready', 'æº–å‚™å°±ç·’');
      }
    });
    
    // é é¢å¸è¼‰æ™‚æ¸…ç†è³‡æº
    window.addEventListener('beforeunload', function() {
      if (sessionTimer) {
        clearInterval(sessionTimer);
      }
      
      if (audioCtx) {
        audioCtx.close();
      }
      
      debugLog('é é¢å¸è¼‰ï¼Œè³‡æºå·²æ¸…ç†');
    });
    
  </script>
</body>
</html>

